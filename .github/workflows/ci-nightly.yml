name: HPL CI Nightly

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  ci-nightly:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Dependencies (Deterministic)
        run: python -m pip install --disable-pip-version-check .
      - name: Secrets Preflight (Signing Key)
        env:
          HPL_CI_ED25519_PRIVATE_KEY: ${{ secrets.HPL_CI_ED25519_PRIVATE_KEY }}
        run: |
          python - <<'PY'
          import binascii
          import os
          import re
          from nacl.signing import SigningKey

          seed = (os.environ.get("HPL_CI_ED25519_PRIVATE_KEY") or "").strip()
          if not seed:
              raise SystemExit("missing HPL_CI_ED25519_PRIVATE_KEY")
          if not re.fullmatch(r"[0-9a-fA-F]{64}", seed):
              raise SystemExit("invalid HPL_CI_ED25519_PRIVATE_KEY format (expected 64 hex chars)")
          try:
              SigningKey(binascii.unhexlify(seed))
          except Exception as exc:
              raise SystemExit(f"invalid HPL_CI_ED25519_PRIVATE_KEY seed: {exc}") from exc
          print("signing secret present and well-formed")
          PY
      - name: Gate A - Spec Integrity
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
        run: python tools/ci_gate_spec_integrity.py
      - name: Gate C - Prohibited Behavior
        run: python tools/ci_gate_prohibited_behavior.py
      - name: Gate L2-A - Registry Validation
        run: python tools/validate_operator_registries.py
      - name: Gate L2-D - Coupling Topology
        run: python tools/validate_coupling_topology.py tests/fixtures/coupling_registry_valid.json
      - name: Gate L2-D Tests - Coupling Topology
        run: python -m unittest tests/test_coupling_topology_validator.py
      - name: Gate L2-B - Traceability
        run: python -m unittest tests/test_traceability.py
      - name: Gate L2-C - Diagnostics
        run: python -m unittest tests/test_diagnostics.py
      - name: Tests - Full Suite
        run: python -m pytest -q
      - name: Epoch Anchor - Generate
        run: |
          mkdir -p artifacts
          python tools/anchor_epoch.py --epoch-id ci --output artifacts/epoch_ci.anchor.json
      - name: Epoch Anchor - Verify
        run: python tools/verify_epoch.py artifacts/epoch_ci.anchor.json
      - name: Epoch Anchor - Sign
        env:
          HPL_CI_ED25519_PRIVATE_KEY: ${{ secrets.HPL_CI_ED25519_PRIVATE_KEY }}
        run: python tools/sign_anchor.py artifacts/epoch_ci.anchor.json --signature-out artifacts/epoch_ci.anchor.sig
      - name: Epoch Anchor - Verify Signature
        run: python tools/verify_anchor_signature.py artifacts/epoch_ci.anchor.json artifacts/epoch_ci.anchor.sig --public-key config/keys/ci_ed25519.pub
      - name: Schema Check - ProgramIR
        run: python tools/validate_ir_schema.py
      - name: Lifecycle - Run (Kernel Default)
        env:
          PYTHONPATH: src
        run: |
          mkdir -p artifacts/lifecycle
          python -m hpl.cli lifecycle examples/momentum_trade.hpl --backend classical --out-dir artifacts/lifecycle --quantum-semantics-v1 > artifacts/lifecycle/summary.json
      - name: Bundle - Sign Manifest
        env:
          HPL_CI_ED25519_PRIVATE_KEY: ${{ secrets.HPL_CI_ED25519_PRIVATE_KEY }}
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path
          from tools import bundle_evidence

          summary_path = Path("artifacts/lifecycle/summary.json")
          if not summary_path.exists():
              raise SystemExit("missing lifecycle summary")
          summary = json.loads(summary_path.read_text(encoding="utf-8"))
          bundle_path = Path(summary.get("bundle_path", ""))
          if not bundle_path.exists():
              raise SystemExit("missing bundle path")
          manifest_path = bundle_path / "bundle_manifest.json"
          if not manifest_path.exists():
              raise SystemExit("missing bundle_manifest.json")

          seed = os.environ.get("HPL_CI_ED25519_PRIVATE_KEY", "").strip()
          if not seed:
              raise SystemExit("missing HPL_CI_ED25519_PRIVATE_KEY")
          key_path = Path("artifacts/ci_bundle_signing.key")
          key_path.write_text(seed, encoding="utf-8")
          bundle_evidence.sign_bundle_manifest(manifest_path, key_path)
          key_path.unlink(missing_ok=True)
          PY
      - name: Bundle - Verify Manifest Signature
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          from tools import bundle_evidence

          summary = json.loads(Path("artifacts/lifecycle/summary.json").read_text(encoding="utf-8"))
          bundle_path = Path(summary.get("bundle_path", ""))
          manifest_path = bundle_path / "bundle_manifest.json"
          signature_path = manifest_path.with_suffix(".sig")
          ok, errors = bundle_evidence.verify_bundle_manifest_signature(
              manifest_path,
              signature_path,
              Path("config/keys/ci_ed25519.pub"),
          )
          if not ok:
              raise SystemExit(f"bundle signature verification failed: {errors}")
          PY
      - name: Bundle - Locate Directory
        id: bundle_path
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          summary = json.loads(Path("artifacts/lifecycle/summary.json").read_text(encoding="utf-8"))
          bundle_path = Path(summary.get("bundle_path", ""))
          if not bundle_path.exists():
              raise SystemExit("missing bundle path for upload")
          manifest_path = bundle_path / "bundle_manifest.json"
          if not manifest_path.exists():
              raise SystemExit("missing bundle_manifest.json for naming")
          manifest = json.loads(manifest_path.read_text(encoding="utf-8"))
          bundle_id = manifest.get("bundle_id")
          if not bundle_id:
              raise SystemExit("missing bundle_id for naming")

          output = Path(__import__("os").environ["GITHUB_OUTPUT"])
          output.write_text(f"bundle_dir={bundle_path}\n" f"bundle_id={bundle_id}\n", encoding="utf-8")
          PY
      - name: Bundle - Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hpl-bundle-${{ github.sha }}-${{ steps.bundle_path.outputs.bundle_id }}
          path: ${{ steps.bundle_path.outputs.bundle_dir }}
